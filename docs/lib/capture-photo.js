/*!
 * @georapbox/capture-photo-element
 * A custom element that implements the MediaDevices.getUserMedia() method of the MediaDevices interface to capture a photo in the browser.
 *
 * @version 5.0.0
 * @homepage https://github.com/georapbox/capture-photo-element#readme
 * @author George Raptis <georapbox@gmail.com>
 * @license MIT
 */
var c=(r,t,e)=>(Number.isNaN(t)&&(t=0),Number.isNaN(e)&&(e=0),Math.min(Math.max(r,Math.min(t,e)),Math.max(t,e)));var a="capture-photo",d=`
  :host { display: block; box-sizing: border-box; }
  :host *, :host *::before, :host *::after { box-sizing: inherit;}
  :host([hidden]), [hidden], ::slotted([hidden]) { display: none; }
  video { display: block; }
  #output:empty { display: none; }
`,u=document.createElement("template");u.innerHTML=`
  <style>${d}</style>
  <video part="video" playsinline></video>
  <canvas hidden></canvas>
  <div part="actions-container">
    <slot name="capture-button">
      <button part="capture-button" type="button">
        <slot name="capture-button-content">Capture photo</slot>
      </button>
    </slot>
    <slot name="actions"></slot>
  </div>
  <slot></slot>
  <div part="output-container" id="output"></div>
`;var l=class r extends HTMLElement{#a={};#t=null;#n=null;#h=null;#e=null;#r=null;#i=null;constructor(){super(),this.#a=this.getSupportedConstraints(),this.shadowRoot||this.attachShadow({mode:"open"}).appendChild(u.content.cloneNode(!0))}static get observedAttributes(){return["no-image","pan","tilt","zoom","torch"]}attributeChangedCallback(t,e,s){if(!this.isConnected)return;let i=this.getTrackCapabilities();if(t==="no-image"&&e!==s&&this.#u(),t==="pan"&&e!==s&&"pan"in this.#a){let o="pan"in i&&i.pan?.min&&i.pan?.max?this.pan>=i.pan.min&&this.pan<=i.pan.max:!1;typeof this.pan=="number"&&o&&this.#o("pan",this.pan)}if(t==="tilt"&&e!==s&&"tilt"in this.#a){let o="tilt"in i&&i.tilt?.min&&i.tilt?.max?this.tilt>=i.tilt.min&&this.tilt<=i.tilt.max:!1;typeof this.tilt=="number"&&o&&this.#o("tilt",this.tilt)}if(t==="zoom"&&e!==s&&"zoom"in this.#a){let o="zoom"in i&&i.zoom?.min&&i.zoom?.max?this.zoom>=i.zoom.min&&this.zoom<=i.zoom.max:!1;typeof this.zoom=="number"&&o&&this.#o("zoom",this.zoom)}t==="torch"&&e!==s&&"torch"in this.#a&&this.#o("torch",this.torch)}async connectedCallback(){if(this.#s("autoPlay"),this.#s("noImage"),this.#s("facingMode"),this.#s("cameraResolution"),this.#s("pan"),this.#s("tilt"),this.#s("zoom"),this.#s("torch"),this.#s("calculateFileSize"),this.#n=this.shadowRoot?.querySelector("canvas")||null,this.#h=this.shadowRoot?.getElementById("output")||null,this.#e=this.shadowRoot?.querySelector("video")||null,this.#r=this.shadowRoot?.querySelector('slot[name="capture-button"]')||null,this.#i=this.#m(),this.#e?.addEventListener("loadedmetadata",this.#l),this.#r?.addEventListener("slotchange",this.#d),this.#i?.addEventListener("click",this.#c),!r.isSupported())return this.dispatchEvent(new CustomEvent(`${a}:error`,{bubbles:!0,composed:!0,detail:{error:{name:"NotSupportedError",message:"Not supported"}}}));this.autoPlay&&this.startVideoStream()}disconnectedCallback(){this.stopVideoStream(),this.#i?.removeEventListener("click",this.#c),this.#e?.removeEventListener("loadedmetadata",this.#l),this.#r?.removeEventListener("slotchange",this.#d)}get autoPlay(){return this.hasAttribute("auto-play")}set autoPlay(t){this.toggleAttribute("auto-play",!!t)}get noImage(){return this.hasAttribute("no-image")}set noImage(t){this.toggleAttribute("no-image",!!t)}get facingMode(){let t=this.getAttribute("facing-mode");return t!=="user"?"environment":t}set facingMode(t){this.setAttribute("facing-mode",t)}get cameraResolution(){return this.getAttribute("camera-resolution")||""}set cameraResolution(t){this.setAttribute("camera-resolution",t)}get pan(){return Number(this.getAttribute("pan"))||0}set pan(t){this.setAttribute("pan",t!=null?t.toString():t)}get tilt(){return Number(this.getAttribute("tilt"))||0}set tilt(t){this.setAttribute("tilt",t!=null?t.toString():t)}get zoom(){return Number(this.getAttribute("zoom"))||1}set zoom(t){this.setAttribute("zoom",t!=null?t.toString():t)}get torch(){return this.hasAttribute("torch")}set torch(t){this.toggleAttribute("torch",!!t)}get calculateFileSize(){return this.hasAttribute("calculate-file-size")}set calculateFileSize(t){this.toggleAttribute("calculate-file-size",!!t)}get loading(){return this.hasAttribute("loading")}#c=t=>{t.preventDefault(),this.capture()};#l=t=>{let e=t.target;e.play().then(()=>{this.dispatchEvent(new CustomEvent(`${a}:video-play`,{bubbles:!0,composed:!0,detail:{video:e}}))}).catch(s=>{this.dispatchEvent(new CustomEvent(`${a}:error`,{bubbles:!0,composed:!0,detail:{error:s}}))}).finally(()=>{this.removeAttribute("loading")})};#u(){this.#h&&this.#h.replaceChildren()}#o(t,e){if(!this.#t)return;let[s]=this.#t.getVideoTracks(),i=this.getTrackCapabilities(),o=this.getTrackSettings(),n=t==="pan"||t==="tilt"||t==="zoom"?c(Number(e),i[t]?.min||1,i[t]?.max||1):e;t in o&&s.applyConstraints({advanced:[{[t]:n}]}).catch(()=>{})}#d=t=>{t.target?.name==="capture-button"&&(this.#i?.removeEventListener("click",this.#c),this.#i=this.#m(),this.#i&&(this.#i.addEventListener("click",this.#c),this.#i.nodeName!=="BUTTON"&&!this.#i.hasAttribute("role")&&this.#i.setAttribute("role","button")))};#m(){return this.#r&&this.#r.assignedElements({flatten:!0}).find(t=>t.nodeName==="BUTTON"||t.getAttribute("slot")==="capture-button")||null}#s(t){let e=this;if(Object.prototype.hasOwnProperty.call(e,t)){let s=e[t];delete e[t],e[t]=s}}async startVideoStream(t){if(!r.isSupported()||this.#t)return;this.setAttribute("loading","");let e={video:{facingMode:{ideal:this.facingMode},pan:!0,tilt:!0,zoom:!0,torch:this.torch},audio:!1};if(typeof t=="string"&&t.trim().length>0&&(e.video.deviceId={exact:t}),typeof this.cameraResolution=="string"&&this.cameraResolution.trim().length>0){let[s=0,i=0]=this.cameraResolution.split("x").map(o=>Number(o));s>0&&i>0&&(e.video.width=s,e.video.height=i)}try{this.#t=await navigator.mediaDevices.getUserMedia(e),this.#e&&(this.#e.srcObject=this.#t),this.#o("pan",this.pan),this.#o("tilt",this.tilt),this.#o("zoom",this.zoom)}catch(s){this.dispatchEvent(new CustomEvent(`${a}:error`,{bubbles:!0,composed:!0,detail:{error:s}}))}finally{this.removeAttribute("loading")}}restartVideoStream(t){this.#t&&this.#e&&this.stopVideoStream(),this.startVideoStream(t)}stopVideoStream(){if(!this.#e||!this.#t)return;let[t]=this.#t.getVideoTracks();t?.stop(),this.#e.srcObject=null,this.#t=null}async capture(){if(!(this.loading||!this.#n||!this.#e))try{let t=this.#n.getContext("2d"),e=this.#e.videoWidth,s=this.#e.videoHeight;this.#n.width=e,this.#n.height=s,t?.drawImage(this.#e,0,0,e,s);let i=this.#n.toDataURL("image/png");if(typeof i=="string"&&i.includes("data:image")){if(!this.noImage){let n=new Image;n.src=i,n.width=e,n.height=s,n.alt="Captured photo",n.setAttribute("part","output-image"),this.#u(),this.#h?.appendChild(n)}let o={dataURI:i,width:e,height:s};if(this.calculateFileSize)try{let h=(await(await fetch(i)).blob()).size;h&&(o.size=h)}catch{}this.dispatchEvent(new CustomEvent(`${a}:success`,{bubbles:!0,composed:!0,detail:o}))}}catch(t){this.dispatchEvent(new CustomEvent(`${a}:error`,{bubbles:!0,composed:!0,detail:{error:t}}))}}getSupportedConstraints(){return r.isSupported()?navigator.mediaDevices.getSupportedConstraints()||{}:{}}getTrackCapabilities(){if(!this.#t)return{};let[t]=this.#t.getVideoTracks();return t&&typeof t.getCapabilities=="function"?t.getCapabilities()||{}:{}}getTrackSettings(){if(!this.#t)return{};let[t]=this.#t.getVideoTracks();return t&&typeof t.getSettings=="function"?t.getSettings()||{}:{}}static async getVideoInputDevices(){return!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices?[]:(await navigator.mediaDevices.enumerateDevices()||[]).filter(e=>e.kind==="videoinput"&&!!e.deviceId)}static isSupported(){return!!navigator.mediaDevices?.getUserMedia}static defineCustomElement(t=a){typeof window<"u"&&!window.customElements.get(t)&&window.customElements.define(t,r)}};export{l as CapturePhoto};
